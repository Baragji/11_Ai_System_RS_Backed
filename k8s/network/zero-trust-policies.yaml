apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: workloads
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-istio-egress
  namespace: workloads
spec:
  podSelector:
    matchLabels:
      istio-injection: enabled
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              istio-namespace: mesh-system
      ports:
        - port: 15012
          protocol: TCP
        - port: 15017
          protocol: TCP
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redis
  namespace: platform
spec:
  podSelector:
    matchLabels:
      app: stateful-agent
  policyTypes:
    - Egress
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              istio-namespace: mesh-system
        - podSelector:
            matchLabels:
              app: stateful-agent
      ports:
        - port: 6379
          protocol: TCP
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              platform-tier: data
      ports:
        - port: 5432
          protocol: TCP
        - port: 9096
          protocol: TCP
